var serverside=!1;"undefined"!=typeof require&&(serverside=!0);if(serverside){var db=require("./database.js"),now=require("./sutils").now,Backbone=require("backbone"),crypto=require("crypto"),names=require("./names.js");Backbone.sync=function(a,b,c){switch(a){case "create":db.create(b,c);break;case "read":b.attributes?db.read(b,c):db.read_all(b,c);break;case "update":db.update(b,c);break;case "delete":db.ddelete(b,c)}}}var models={};
models.Video=Backbone.Model.extend({db_fields:["queue_id","prev","next","url","time"],defaults:{queue_id:0,prev:0,next:0,url:"00000000000",time:0,thumb:"static/img/novid.png",title:"Loading video...",uploader:"",time_text:"",watched:!1},initialize:function(){this.classname="video";if(serverside&&!this.id&&this.get("hash")){var a=crypto.createHash("md5");a.update(""+Math.random());this.set("id",a.digest("hex"))}!serverside&&this.verify()&&this.fetch_yt()},fetch_yt:function(){var a="http://gdata.youtube.com/feeds/api/videos/"+
this.get("url")+"?v=2&alt=json&key=AI39si5Us3iYwmRdK0wa2Qf2P9eV-Z8tbjogUWw1B4JQUs191PgYNJChEKEooOq6ykQzhywLEBA9WxuKphpWUoCRA7S7jeLi5w",b=this;$.get(a,function(a){var d=parseInt(a.entry.media$group.yt$duration.seconds),e=Math.floor(d/60),f=d%60+"";2!=f.length&&(f="0"+f);b.set({title:a.entry.title.$t,uploader:a.entry.author[0].name.$t,time:d,thumb:a.entry.media$group.media$thumbnail[0].url,time_text:e+":"+f})})},verify:function(){var a=this.get("url");return"string"!=typeof a||11!=a.length||"00000000000"==
a?!1:!0}});
models.VideoList=Backbone.Collection.extend({model:models.Video,initialize:function(){this.classname="video"},get_first:function(){var a=new models.Video({url:"Bq6WULV78Cw"});return this.at(0)||a},after:function(a){a=this.get(a.id);return!a?this.at(0):(a=a.get("next"))?this.get(a)||this.get_first():this.at(0)||this.get_first()},append:function(a){var b=this,a={url:a.url,time:a.time};if(this.id)if(0==this.length){a.queue_id=this.id;var c=new models.Video(a);c.save({},{success:function(){b.add(c)}})}else{var d=this.last();
d.id&&(a.prev=d.id);a.queue_id=this.id;c=new models.Video(a);c.save({},{success:function(){d.save({next:c.id},{success:function(){b.add(c)}})}})}else a.hash=!0,c=new models.Video(a),c.verify()&&this.add(c)},insert:function(a,b){video=new models.Video({hash:!0,url:a.url,time:a.time});if(video.verify()){var c;b&&(c=b.id);c=this.indexOf(this.get(c));this.add(video,{at:c+1})}},kill:function(a){var b=this.get(a.get("prev")),c=this.get(a.get("next"));b&&b.set("next",a.get("next"));c&&c.set("prev",a.get("prev"));
b&&b.save();c&&c.save();a.destroy();this.remove(a)}});
models.Player=Backbone.Model.extend({defaults:{state:"paused",current:new models.Video,prev:new models.Video,time:0},play:function(){this.set("state","playing");this.trigger("action")},pause:function(){this.set("state","paused");this.trigger("action")},initialize:function(){this.start_ticker();this.get("current")},start_ticker:function(){var a=this;setInterval(function(){a.tick()},1E3)},tick:function(){if(this.get("current")){var a=this.get("time");"playing"==this.get("state")&&(a+=1);a<=this.get("current").get("time")?
this.set({time:a},{silent:!0}):this.trigger("end")}},set_vid:function(a){a.set({watched:!0});this.set({time:0,current:a,state:"playing"})},seek:function(a){var b=this.get("current").get("time");a<b?this.set("time",a):this.set("time",b);this.trigger("action")},time:function(){var a=this.get("time"),b=""+Math.floor(a/60),a=""+a%60;2>a.length&&(a="0"+a);return b+":"+a}});
models.Message=Backbone.Model.extend({defaults:{author:0,content:"",time:0,rendered:!1},initialize:function(){if(!this.id){var a=crypto.createHash("md5");a.update(""+Math.random());this.set("id",a.digest("hex"))}this.get("time")||this.set("time",(new Date).getTime())}});models.MessageList=Backbone.Collection.extend({model:models.Message});
models.User=Backbone.Model.extend({defaults:{username:"",avatar_url:"/static/avatars/newfoal.png"},initialize:function(){this.classname="user";if(this.get("blank"))this.attributes=this.get("blank");else{if(!this.id&&serverside){var a=crypto.createHash("md5");a.update(""+Math.random());this.set("id",a.digest("hex"))}!this.get("username")&&serverside&&this.set("username",names.gen_name())}}});models.UserList=Backbone.Collection.extend({model:models.User,initialize:function(){this.classname="user"}});
models.Room=Backbone.Model.extend({defaults:{userlist:new models.UserList,queue:new models.VideoList,playlist:new models.VideoList,player:new models.Player,mutelist:new models.UserList,modlist:new models.UserList,owner:new models.User,messages:new models.MessageList},initialize:function(){this.classname="room";serverside&&this.db_fetch();var a=this,b=this.get("player");b.on("end",function(){b.set_vid(a.next_video())})},db_fetch:function(){var a=this,b=new Backbone.Collection;b.classname="mod";b.query=
"room_id="+this.id;b.fetch();b.bind("reset",function(){b.each(function(b){b=new models.User({id:b.get("user_id")});b.fetch();a.get("modlist").add(b)})});var c=this.get("playlist"),d=this.get("player");c.on("reset",function(){d.get("current").get("time")||d.set_vid(c.get_first())});c.id=this.get("queue_id");c.query="queue_id="+c.id;c.fetch();var e=this.get("owner");e.id=this.get("owner_id");e.fetch()},next_video:function(){var a=this.get("player").get("current"),a=this.get("playlist").after(a),b=this.get("queue").where({watched:!1});
b.length&&(a=b[0]);return a},message:function(a,b){if(this.get("userlist").get(a.id)&&!this.get("mutelist").get(a.id)){var c=this.get("messages");100<=c.length&&c.reset();c.add({author:a.id,content:b})}},join:function(a){this.get("userlist").add(a)},leave:function(a){this.get("userlist").remove(a.id)},json:function(){var a=this.toJSON();a.messages=[];return a}});models.RoomList=Backbone.Collection.extend({model:models.Room,initialize:function(){this.classname="room"}});models.SessionStore=Backbone.Model.extend({});
serverside&&(module.exports=models);var ConnectionApi=Backbone.Model.extend({defaults:{refresh:2E3},initialize:function(){var a=io.connect(this.get("ip"));this.set("sock",a);a.on("connect",function(){console.log("connected");a.emit("join",window.room.id)});this.start_player_loop();this.bind_room_events();this.bind_sock_events()},start_player_loop:function(){var a=this.get("sock");setInterval(function(){a.emit("player_prompt")},this.get("refresh"))},bind_room_events:function(){var a=this.get("room"),b=this.get("user"),c=this.get("sock");
a.bind("message",function(a){c.emit("message",a);console.log("outputting message "+a)});var d=a.get("player");d.bind("action",function(){c.emit("player_action",d.toJSON());console.log("outputting player state")});a.on("play play_new",function(a){c.emit("play_video",a.toJSON())});a.on("delete",function(a){c.emit("remove_video",a.toJSON())});a.on("queue",function(a){c.emit("add_queue",a.toJSON())});a.on("playlist",function(a){c.emit("add_playlist",a.toJSON())});b.on("login",function(){c.emit("login",
b.toJSON())});b.on("logout",function(){c.emit("logout")})},bind_sock_events:function(){var a=this.get("room"),b=this.get("user"),c=this.get("sock");c.on("player",function(b){var c=a.get("player");c.set({state:b.state,time:b.time});c.get("current").id!=b.current.id&&c.set("current",new models.Video(b.current))});c.on("status",function(b){a.trigger("status",b)});c.on("userlist",function(b){a.get("userlist").reset(b)});c.on("message",function(b){a.get("messages").add(b)});c.on("playlist",function(b){a.get("playlist").reset(b)});
c.on("queue",function(b){a.get("queue").reset(b)});c.on("login",function(a){a||alert("bad password");b.set(a)})}});var ChatView=Backbone.View.extend({initialize:function(){var a=this;this.model.get("messages").bind("add",function(){var b=room.get("messages").where({rendered:!1});$.each(b,function(b,c){a.message(c);c.set("rendered",!0)})});var b=this.$el.find("#messages");room.bind("status",function(c){var d=$('<div id="status">');d.html(c);b.append(d);b.scrollTop(b[0].scrollHeight);a.options.status=!0})},message:function(a){var b=this.$el.find("#messages"),c=this.last_message_view;if(this.options.status||!c||
!c.append(a))c=new MessageView({model:a}),c.render(),b.append(c.el),this.last_message_view=c;b=$("#messages");b.scrollTop(b[0].scrollHeight);this.options.status=!1},render:function(){var a=this.model,b=this.$el,c=this;b.find("#mouth #avatar img").attr("src",window.user.get("avatar_url"));var d=b.find("#mouth #input input");d.keydown(function(e){13==e.keyCode&&("/clear"==d.val()?(c.last_message_view=null,b.find("#messages").html("")):a.trigger("message",d.val()),d.val(""))})}}),MessageView=Backbone.View.extend({initialize:function(){if(this.model){var a=
this.model.get("content");is_img_link(a)?(this.options.url=a,this.options.thumbnail=a):is_yt_link(a)&&(a=get_yt_vidid(a),this.options.video=new models.Video({url:a}),this.options.video.bind("change",this.render,this),this.options.url="http://youtube.com/watch?v="+a,this.options.thumbnail=get_yt_thumbnail(a))}},media:function(a){a=a.get("content");return is_img_link(a)||is_yt_link(a)},append:function(a){if(this.options.thumbnail||this.media(a)||a.get("author")!=this.model.get("author"))return!1;this.options.appendum||
(this.options.appendum=[]);this.options.appendum.push(a);this.render();return!0},render:function(){var a=make_links(this.model.get("content")),b=this.$el,c=this,d="/static/avatars/sleep.png",e="Offline User";if(window.room){var f=room.get("userlist").get(this.model.get("author"));f&&(d=f.get("avatar_url"),e=f.get("username"))}this.options.appendum&&$.each(this.options.appendum,function(b,c){a+="<br/>";a+=make_links(c.get("content"))});this.options.thumbnail&&this.options.url?this.options.video?(b.html(_.template($("script#video_msg").html(),
{avatar:d,username:e,content:a,url:this.options.url,thumb:this.options.thumbnail,title:this.options.video.get("title"),uploader:this.options.video.get("uploader"),time_text:this.options.video.get("time_text")})),b.find("#play").click(function(){window.room.trigger("play_new",c.options.video)}),b.find("#queue").click(function(){window.room.trigger("queue",c.options.video)}),b.find("#playlist").click(function(){window.room.trigger("playlist",c.options.video)})):b.html(_.template($("script#image_msg").html(),
{avatar:d,username:e,content:a,url:add_pretext(this.options.url),thumb:add_pretext(this.options.thumbnail)})):d==b.find(".avatar img").attr("src")&&e==b.find("#username").html()?b.find("#content").html(a):b.html(_.template($("script#message").html(),{avatar:d,username:e,content:a}));var b=b.find("img"),g=$("#messages");b&&$.each(b,function(a,b){$(b).load(function(){g.scrollTop(g[0].scrollHeight)})})}});$(document).ready(function(){window.room=new models.Room;for(idx in globals.room){var a=globals.room[idx];if("object"==typeof a){var b=room.get(idx);if(b.reset)b.reset(a);else if(b.set)for(idx2 in a){var c=a[idx2],d=b.get(idx2);"object"!=typeof c?b.set(idx2,c):d.set?d.set(c):d.reset&&d.reset(c)}}}window.room.id=globals.room.id;window.user=new models.User(globals.user);window.api=new ConnectionApi({ip:"ws://"+window.location.host,room:window.room,user:window.user,refresh:1E3});window.cv=new CatalogView({el:$("#catalog"),
playlists:{queue:room.get("queue"),playlist:room.get("playlist")}});cv.render();window.plv=new PlayerView({el:$("#theater"),model:room.get("player"),tolerance:5});room.get("player").get("current").initialize();plv.render();window.cv=new ChatView({el:$("#chatroom"),model:room});cv.render();window.ulv=new UserListView({el:$("#chatroom"),model:room.get("userlist")});ulv.render();window.liv=new LoginView({el:$("#login"),model:window.user});liv.render();window.cams=new CamsView({el:$("#cams")});$("body").click(function(){$("#menu").remove()});
$("#theater")[0].onselectstart=function(){return!1};$("#catalog")[0].onselectstart=function(){return!1};$("#header")[0].onselectstart=function(){return!1}});var CatalogView=Backbone.View.extend({initialize:function(){var a=this.$el,b=this;this.subviews={};$.each(this.options.playlists,function(c){a.find(".section#"+c).click(function(){b.show(c)})});room.get("player").bind("change:current",this.show_current,this)},render:function(){var a=this.$el.find("#videos").empty(),b=this;$.each(this.options.playlists,function(c,d){var e=$("<div>"),f=b.$el.find(".section#"+c+" #count");a.append(e);b.subviews[c]=new PlaylistView({model:d,el:e,cel:f});b.subviews[c].render()});
this.show_current()},show:function(a){$.each(this.subviews,function(b,c){b==a?c.$el.css("display","block"):c.$el.css("display","none")});this.$el.find(".section.selected").removeClass("selected");this.$el.find(".section#"+a).addClass("selected")},show_current:function(){var a=this;$.each(this.options.playlists,function(b,c){var d=room.get("player").get("current");c.get(d.id)&&a.show(b)})}}),PlaylistView=Backbone.View.extend({initialize:function(){this.model.bind("add remove reset",this.render,this);
room.get("player").bind("change:current",this.render_current,this);this.subviews={}},render:function(){var a=this,b=this.$el.empty();this.options.cel.html("("+this.model.length+")");this.model.each(function(c){var d=a.subviews[c.id];d||(d=new PlaylistItemView({model:c,removable:!0}),a.subviews[c.id]=d);b.append(d.el);d.render()});this.render_current()},render_current:function(){this.$el.find("#video.selected").removeClass("selected");var a=this.subviews[room.get("player").get("current").id];a&&a.$el.addClass("selected")}}),
PlaylistItemView=Backbone.View.extend({initialize:function(){this.model.bind("change",this.render,this);this.template=_.template($("script#video").html())},render:function(){var a=this.$el,b=this,c=$(this.template(this.model.toJSON()));a.html(c.html());this.options.removable&&(a.find("#thumbnail, #info").click(function(){room.trigger("play",b.model)}),a.hover(function(){a.find("#actions").css("display","block")},function(){a.find("#actions").css("display","none")}),a.find("#open").click(function(){var a=
"http://youtube.com/watch?v="+b.model.get("url");window.open(a,"_blank")}),a.find("#delete").click(function(){window.room.trigger("delete",b.model)}));a.attr("id",c.attr("id"))}});var chromeless="http://www.youtube.com/apiplayer?version=3&enablejsapi=1&playerapiid=player1",PlayerView=Backbone.View.extend({initialize:function(){var a=this,b=this.$el;this.options.dimensions||(this.options.dimensions={width:853,height:480});this.options.tolerance||(this.options.tolerance=2);window.onYouTubePlayerReady=function(){a.ready()};this.model.bind("change",this.render,this);room.get("playlist").bind("reset add remove",this.render,this);room.get("queue").bind("reset add remove",this.render,
this);room.get("player").bind("change:current",this.render,this);this.$el.find("#play").click(function(){"playing"==a.model.get("state")?a.model.pause():a.model.play()});this.$el.find("#overlay").click(function(){"playing"==a.model.get("state")?a.model.pause():a.model.play()});var c=this.$el.find("#scrobbler"),d=this.$el.find("#playhead");c.click(function(b){var e=a.model.get("current");e&&(b=b.offsetX/(c.width()-d.width()),e=Math.floor(b*e.get("time")),a.model.seek(e))});c.hover(function(){d.css("background-color",
"red")},function(){d.css("background-color","white")});var e=b.find("#next"),f=b.find("#next_vid"),g=new PlaylistItemView({model:room.next_video(),el:f});g.render();this.pliv=g;f.css({display:"none",position:"absolute",left:-f.width()+e.width(),top:-f.height(),"text-align":"left",border:"none"});e.hover(function(){f.css("display","block")},function(){f.css("display","none")});e.click(function(){"Bq6WULV78Cw"!=room.next_video().get("url")&&3!=event.which&&room.trigger("play",room.next_video())});var e=
b.find("#volume"),h=e.find("#volume_slider");e.hover(function(){b.find("#mute,#max").css("display","block")},function(){b.find("#mute,#max").css("display","none")});b.find("#vol").mousedown(function(b){var c=100*(b.offsetX/$(this).width());a.volume(c);h.width(b.offsetX)});b.find("#max").click(function(){a.volume(100);h.width("100%")});b.find("#mute").click(function(){a.volume(0);h.width(0)});this.$el.find("#vid_title").click(function(){var b="http://youtube.com/watch?v="+a.model.get("current").get("url");
window.open(b,"_blank")})},render:function(){var a=this.$el;!this.player&&window.swfobject&&swfobject.embedSWF(chromeless,"youtube",String(this.options.dimensions.width),String(this.options.dimensions.height),"9",null,null,{allowScriptAccess:"always"},{id:"apiplayer"});if(this.player){var b=this.model.get("time"),c=this.player.getCurrentTime();Math.abs(c-b)>this.options.tolerance&&this.player.seekTo(b,!0);b=this.model.get("current").get("url");c=get_yt_vidid(this.player.getVideoUrl());b!=c&&this.player.cueVideoById(b);
b=this.model.get("state");c=this.player.getPlayerState();"playing"==b&&1!=c&&3!=c?this.player.playVideo():"paused"==b&&1==c&&this.player.pauseVideo()}this.pliv.model=room.next_video();this.pliv.render();"playing"==this.model.get("state")?a.find("#play").html("pause"):a.find("#play").html("play");this.$el.find("#vid_title").html("Now Playing: "+this.model.get("current").get("title"));b=a.find("#playhead");a=a.find("#scrobbler");c=this.model.get("time")/this.model.get("current").get("time");a=(a.width()-
b.width())*c;b.css("visibility","");b.css("margin-left",a);b=$("#ph_time");b.html(this.model.time());b.css({left:a-b.width()/2,top:-b.height()-8});this.model.get("current")&&this.model.get("current").get("title")&&$("#banner").html(this.model.get("current").get("title"))},ready:function(){this.player=document.getElementById("apiplayer");this.volume(50);this.trigger("ready")},set_video:function(a){player&&this.player.cueVideoById(a.get("url"))},update:function(a){if(this.player){switch(this.model.get("state")){case "playing":this.player.playVideo();
case "paused":this.player.pauseVideo()}this.player.getCurrentTime();a.time-this.player.get("time")>this.options.tolerance&&this.set("time",a.time)}},play:function(){this.player&&this.player.playVideo()},pause:function(){this.player&&this.player.pauseVideo()},volume:function(a){this.player&&this.player.setVolume(a)}});window.UserListView=Backbone.View.extend({initialize:function(){this.model.bind("add remove reset",this.render,this);this.subviews={};var a=this.$el.find("#header #user"),b=this.$el.find("#users");a.click(function(){"none"==b.css("display")?b.css("display","block"):b.css("display","none")});this.$el.find("#cam").click(function(){$(this).hasClass("selected")?cams.quit():(cams.join(),$(this).toggleClass("selected"))})},render:function(){this.$el.find("#header #user").html(this.model.length+" Users");
var a=this.$el.find("#users").empty(),b=this.subviews;this.model.each(function(c){var d=b[c.id];d||(d=new UserView({model:c}),b[c.id]=d);a.append(d.el);d.render()})}});
window.UserView=Backbone.View.extend({initialize:function(){this.model.bind("change",this.render,this)},render:function(){var a=_.template($("script#user").html()),b=this.model,c=this.$el;c.html(a({avatar:this.model.get("avatar_url"),username:this.model.get("username")}));c.bind("contextmenu",function(a){$("#menu").remove();var e=$('<div id="menu"><div class="menuitem" id="mute">Mute</div><div class="menuitem" id="hide">Hide</div></div>');e.css({position:"absolute",left:a.offsetX,top:a.offsetY});
e.find(".menuitem").hover(function(){$(this).addClass("hover")},function(){$(this).removeClass("hover")});e.find("#mute").mousedown(function(a){b.trigger("mute");$("#menu").remove();c.removeClass("hover");a.preventDefault()});c.append(e);a.preventDefault()})}});window.LoginView=Backbone.View.extend({initialize:function(){this.model.bind("change reset",this.render,this);var a=this.$el,b=a.find("#unfield"),c=a.find("#password"),d=this.model,e=function(){d.set({username:b.val(),password:c.val()});d.trigger("login")};b.keydown(function(a){13==a.keyCode&&e()});c.keydown(function(a){13==a.keyCode&&e()});a.find("#login_button").click(e);a.find("#reg_button").click(e);a.find("#logout").click(function(){d.trigger("logout")});a.find("#username").hover(function(a){var b=
$('<div id="smenu">');b.css({width:100,height:100,"background-color":"white",position:"absolute",top:a.offsetY,left:$(this).screenX});$(this);$("body").append(b)},function(){$("#smenu").remove()})},render:function(){var a=this.$el;this.model.id&&32>(this.model.id+"").length?(a.find("#username").css("display",""),a.find("#logout").css("display",""),a.find("#fields").css("display","none"),a.find("#username").html(this.model.get("username")),a.find("#avatar img").attr("src",this.model.get("avatar_url"))):
(a.find("#logout").css("display","none"),a.find("#username").css("display","none"),a.find("#fields").css("display",""))}});var CamsView=Backbone.View.extend({join:function(){var a=this.$el;this.$el.css("display","block");var b=_.template($("script#cam").html()),c=$(b());a.append(c);rtc.createStream({video:!0,audio:!0},function(a){c.attr("src",URL.createObjectURL(a))});rtc.connect("ws://"+window.location.hostname+":4000/",window.room.id);rtc.on("add remote stream",function(c,e){var f=$(b());f.attr({id:e,src:URL.createObjectURL(c)});a.append(f)});rtc.on("disconnect stream",function(a){$(document.getElementById(a)).remove()})},
quit:function(){alert("there's no other way to quit cams other than to refresh the page. i'm getting this fixed as soon as possible.")}});
